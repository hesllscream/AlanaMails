---
/**
 * Dynamic Landing Page for Prospects
 * Loads prospect data client-side from Supabase using query param
 * URL: /p?s=slug-here
 */
import BaseLayout from '@/layouts/BaseLayout.astro'
import HeroSection from '@/ui/components/organisms/Hero/Hero.astro'
import FeaturesSection from '@/ui/components/organisms/FeaturesSection/FeaturesSection.astro'
import AuditSection from '@/ui/components/organisms/AuditSection/AuditSection.astro'
import PricingSection from '@/ui/components/organisms/PricingSection/PricingSection.astro'
import SyndicateSection from '@/ui/components/organisms/SyndicateSection/SyndicateSection.astro'
import ZombieSection from '@/ui/components/organisms/ZombieSection/ZombieSection.astro'
import Footer from '@/ui/components/organisms/Footer/Footer.astro'
---

<BaseLayout title="Propuesta Privada - Alana AI">
  <!-- Loading State -->
  <div id="loadingState" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-cr-pink/30 border-t-cr-pink rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-cr-muted">Cargando tu propuesta...</p>
    </div>
  </div>

  <!-- Error State -->
  <div id="errorState" class="hidden min-h-screen flex items-center justify-center">
    <div class="text-center">
      <p class="text-cr-muted mb-4">No se encontr√≥ esta propuesta</p>
      <a href="/" class="text-cr-pink hover:underline">Volver al inicio</a>
    </div>
  </div>

  <!-- Main Content (hidden until data loads) -->
  <main id="mainContent" class="hidden">
    <HeroSection name="[NOMBRE]" platform="[PLATAFORMA]" />
    <FeaturesSection />
    <AuditSection />
    <ZombieSection />
    <PricingSection />
    <SyndicateSection />
    <Footer name="[NOMBRE]" />
  </main>
</BaseLayout>

<script>
  import { supabase } from '@/lib/supabase'

  async function loadProspect() {
    const urlParams = new URLSearchParams(window.location.search)
    const slug = urlParams.get('s')

    if (!slug) {
      showError()
      return
    }

    try {
      const { data: prospect, error } = await supabase
        .from('prospects')
        .select('name, platform')
        .eq('slug', slug)
        .single()

      if (error || !prospect) {
        showError()
        return
      }

      // Update all [NOMBRE] placeholders
      document.querySelectorAll('*').forEach(el => {
        if (el.childNodes.length === 1 && el.childNodes[0].nodeType === Node.TEXT_NODE) {
          const text = el.textContent || ''
          if (text.includes('[NOMBRE]')) {
            el.textContent = text.replace(/\[NOMBRE\]/g, prospect.name)
          }
          if (text.includes('[PLATAFORMA]')) {
            el.textContent = text.replace(/\[PLATAFORMA\]/g, prospect.platform)
          }
        }
      })

      // Update title
      document.title = `Propuesta para ${prospect.name} - Alana AI`

      // Show content
      document.getElementById('loadingState')?.classList.add('hidden')
      document.getElementById('mainContent')?.classList.remove('hidden')

    } catch (err) {
      console.error('Error loading prospect:', err)
      showError()
    }
  }

  function showError() {
    document.getElementById('loadingState')?.classList.add('hidden')
    document.getElementById('errorState')?.classList.remove('hidden')
  }

  loadProspect()
</script>
